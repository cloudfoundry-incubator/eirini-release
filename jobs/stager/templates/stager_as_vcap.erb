#!/bin/bash -e

run_dir=/var/vcap/sys/run/stager
log_dir=/var/vcap/sys/log/stager
conf_dir=/var/vcap/jobs/stager/config
pidfile=$run_dir/stager.pid

echo $$ > $pidfile

exec /var/vcap/packages/eirini/bin/eirini stage  \
  --kubeconfig "$conf_dir/kube.yml" \
  --cf-endpoint <%= p('eirini_stager.ccAPI') %> \
  --cf-username <%= p('eirini_stager.adminUser') %> \
  --cf-password <%= p('eirini_stager.adminPassword') %> \
  --eirini-address <%= p('eirini_stager.eirini_address') %> \
  --namespace <%= p('eirini_stager.kube_namespace') %> \
  <% if p("eirini_stager.skipSslValidation") %>--skipSslValidation<% end %> \
  2> >(tee -a $log_dir/stager.stderr.log | logger -p user.error -t vcap.stager) \
  1> >(tee -a $log_dir/stager.stdout.log | logger -t vcap.stager)
